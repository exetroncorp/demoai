FROM debian:12

# Install dependencies
RUN apt-get update && apt-get install -y \
    openssh-server \
    curl \
    dos2unix \
    && rm -rf /var/lib/apt/lists/*

# Setup SSH
RUN mkdir /var/run/sshd
RUN echo 'root:password' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Install wstunnel
RUN curl -L -o /tmp/wstunnel.tar.gz https://github.com/erebe/wstunnel/releases/download/v10.5.1/wstunnel_10.5.1_linux_amd64.tar.gz \
    && tar -xzf /tmp/wstunnel.tar.gz -C /usr/local/bin/ \
    && chmod +x /usr/local/bin/wstunnel \
    && rm /tmp/wstunnel.tar.gz

# Expose wstunnel port
EXPOSE 11111

# Copy entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN dos2unix /entrypoint.sh && chmod +x /entrypoint.sh

CMD ["/entrypoint.sh"]

-----

    #!/bin/bash

# Start SSH server
/usr/sbin/sshd

# Start wstunnel server
# Listening on 0.0.0.0:11111 and forwarding to localhost:22
echo "Starting wstunnel server on port 11111..."
/usr/local/bin/wstunnel server ws://0.0.0.0:11111 --restrict-to 127.0.0.1:22

-----

    $wstunnel = ".\wstunnel.exe"
$ssh = "C:\Program Files\Git\usr\bin\ssh.exe"

# Check if wstunnel exists
if (-not (Test-Path $wstunnel)) {
    Write-Error "wstunnel.exe not found in current directory."
    exit 1
}

# Start wstunnel client in a new window
# Forwarding local port 2222 to remote 127.0.0.1:22 via websocket at localhost:11111
Write-Host "Starting wstunnel client..."
Start-Process -FilePath $wstunnel -ArgumentList "client -L tcp://127.0.0.1:2222:127.0.0.1:22 ws://localhost:11111"

Write-Host "Waiting for tunnel to establish..."
Start-Sleep -Seconds 3

# Connect via SSH
Write-Host "Connecting to SSH server..."
& $ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@localhost


